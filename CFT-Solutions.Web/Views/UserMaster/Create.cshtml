@model CFT_Solutions.Core.Entity.UserMaster.UserMasterEntity
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = Model?.Id > 0 ? "Edit User Master" : "Create User Master";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <h2>@ViewData["Title"]</h2>

            <form asp-action="Create" method="post" class="mt-4" id="userForm">
                @Html.AntiForgeryToken()
                <input asp-for="Id" type="hidden" />
                <input asp-for="EncryptedParam" type="hidden" />

                <div class="mb-3">
                    <label asp-for="FirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                    <input asp-for="FirstName" class="form-control" required />
                    <span asp-validation-for="FirstName" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="LastName" class="form-label">Last Name</label>
                    <input asp-for="LastName" class="form-control" />
                    <span asp-validation-for="LastName" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="EmailId" class="form-label">Email <span class="text-danger">*</span></label>
                    <input asp-for="EmailId" class="form-control" type="email" required />
                    <span asp-validation-for="EmailId" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="MobileNo" class="form-label">Mobile No</label>
                    <input asp-for="MobileNo" class="form-control" />
                    <span asp-validation-for="MobileNo" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Password" class="form-label">Password <span class="text-danger">*</span></label>
                    <input asp-for="Password" class="form-control" type="password" required />
                    <span asp-validation-for="Password" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="RoleId" class="form-label">Role</label>
                    <select asp-for="RoleId" asp-items="(IEnumerable<SelectListItem>)ViewBag.Roles" class="form-select">
                        <option value="">-- Select Role --</option>
                    </select>
                    <span asp-validation-for="RoleId" class="text-danger"></span>
                </div>

                <div class="mb-3 form-check">
                    <input asp-for="IsActive" type="checkbox" class="form-check-input" />
                    <label asp-for="IsActive" class="form-check-label">Active</label>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
}

    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            var roleSelect = document.getElementById('RoleId');
            var adminFields = document.getElementById('adminFields');
            var engineerFields = document.getElementById('engineerFields');

            function hideAll() {
                if (adminFields) adminFields.style.display = 'none';
                if (engineerFields) engineerFields.style.display = 'none';
            }

            function showAdmin() {
                if (adminFields) adminFields.style.display = '';
                if (engineerFields) engineerFields.style.display = 'none';
            }

            function showEngineer(roleId) {
                if (adminFields) adminFields.style.display = 'none';
                if (engineerFields) engineerFields.style.display = '';
                // populate engineer dropdown via same server endpoint used for users by role
                if (!roleId) return;
                fetch('@Url.Action("GetUsersByRole", "UserMaster")?roleId=' + encodeURIComponent(roleId))
                    .then(function (r) { return r.json(); })
                    .then(function (data) {
                        var engSelect = document.getElementById('EngineerId');
                        if (!engSelect) return;
                        engSelect.innerHTML = '<option value="">-- Select engineer --</option>';
                        data.forEach(function (u) {
                            var opt = document.createElement('option');
                            opt.value = u.Value || u.id || u.Id;
                            opt.text = u.Text || u.text || u.UserName;
                            engSelect.appendChild(opt);
                        });
                    }).catch(function () { /* ignore */ });
            }

            function applyRoleToggle() {
                if (!roleSelect) return;
                var selectedOpt = roleSelect.options[roleSelect.selectedIndex];
                var roleText = (selectedOpt && selectedOpt.text) ? selectedOpt.text.toLowerCase() : '';
                var roleId = roleSelect.value;
                hideAll();
                if (roleText.indexOf('admin') !== -1) {
                    showAdmin();
                } else if (roleText.indexOf('engineer') !== -1) {
                    showEngineer(roleId);
                } else {
                    hideAll();
                }
            }

            if (roleSelect) {
                roleSelect.addEventListener('change', applyRoleToggle);
                // initialize on load (useful when editing or when model preselects a role)
                applyRoleToggle();
            }

            // keep any existing AJAX form handling logic intact if needed
            var form = document.getElementById('userForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    // leave default behaviour (server post) or implement AJAX submit if desired.
                    // If you previously used AJAX submit, you can restore it here.
                });
            }
        })();
    </script>
}